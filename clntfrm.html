<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Client Form — SJ Consultation Team</title>
  <style>
    :root{
      --accent-blue: #0b74ff;
      --auth-gray: #4b5563;
      --bg: #f6f8fb;
      --surface: #ffffff;
      --text: #071426;
      --muted: #6b7280;
      --shadow: 0 10px 30px rgba(11,23,35,0.08);
      --card-radius: 14px;
      --focus: rgba(11,116,255,0.14);
      --max-width: 780px;
    }

    [data-theme="dark"]{
      --bg: #071021;
      --surface: #071425;
      --text: #e6eef9;
      --muted: #9aa6b3;
    }

    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
    a{color:inherit}
    /* Container + pt-6 (1.5rem) at top */
    main.page{
      min-height:100vh;
      display:flex;
      align-items:flex-start;
      justify-content:center;
      padding:24px 16px 48px; /* pt-6 = 24px */
    }

    .card{
      width:100%;
      max-width:var(--max-width);
      background:var(--surface);
      border-radius:var(--card-radius);
      box-shadow:var(--shadow);
      overflow:hidden;
      border:1px solid rgba(11,23,35,0.04);
    }

    /* header/banner (photo6) */
    .card-banner{position:relative;height:160px;background:#0b74ff;overflow:hidden}
    .card-banner img{width:100%;height:100%;object-fit:cover;display:block;filter:contrast(1.02) saturate(0.98)}
    .banner-overlay{
      position:absolute;inset:0;
      background: linear-gradient(180deg, rgba(11,116,255,0.28), rgba(11,116,255,0.02));
      display:flex;align-items:center;justify-content:center;
    }
    .title-wrap{
      text-align:center;color:white;padding:18px 16px;
    }
    .title-gradient{
      font-size:26px;font-weight:800;letter-spacing:0.6px;
      background: linear-gradient(90deg,var(--accent-blue),var(--auth-gray));
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;
      margin:0;
    }
    .subtitle{margin:6px 0 0 0;color:rgba(255,255,255,0.90);font-weight:600;font-size:13px}

    .card-body{padding:22px 22px 28px}

    form{width:100%}
    label{display:block;font-weight:700;margin-bottom:6px;font-size:14px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .full{grid-column:1/-1}
    input,select,textarea{
      width:100%;padding:12px 14px;border-radius:10px;border:1px solid rgba(11,23,35,0.08);font-size:15px;background:transparent;color:var(--text);
    }
    textarea{min-height:120px;resize:vertical}
    .muted{color:var(--muted);font-size:13px}
    .actions{display:flex;gap:12px;justify-content:flex-end;margin-top:16px}
    .btn{padding:10px 14px;border-radius:10px;border:0;font-weight:800;cursor:pointer}
    .btn-primary{background:linear-gradient(90deg,var(--accent-blue),var(--auth-gray));color:white;box-shadow:0 10px 26px rgba(11,116,255,0.10)}
    .btn-ghost{background:transparent;border:1px solid rgba(11,23,35,0.06)}
    .note{font-size:13px;color:var(--muted);margin-top:8px}

    .verify-block{margin-top:14px;padding:12px;border-radius:10px;border:1px solid rgba(11,23,35,0.04);background:linear-gradient(180deg, rgba(11,116,255,0.02), transparent)}
    .inline{display:inline-flex;gap:8px;align-items:center}
    #recaptcha-container{margin-top:8px}

    .message{margin-top:10px}
    .error{padding:10px;border-radius:8px;background:#fff1f1;border:1px solid #ffbebe;color:#7a1200}
    .success{padding:10px;border-radius:8px;background:#e6ffef;border:1px solid #b7f0d0;color:#04632f}

    /* header with theme toggle */
    header.sitehead{position:sticky;top:0;z-index:60;background:transparent;padding:12px 20px}
    .sitehead-inner{display:flex;align-items:center;justify-content:center;gap:12px}
    .theme-btn{position:absolute;right:18px;top:14px;display:inline-flex;align-items:center;gap:10px;padding:8px;border-radius:10px;border:1px solid rgba(11,23,35,0.06);background:var(--surface);cursor:pointer;box-shadow:0 8px 20px rgba(2,6,23,0.04)}
    .theme-btn img{height:20px;width:20px;display:block}

    @media (max-width:760px){
      .grid{grid-template-columns:1fr}
      .actions{flex-direction:column;align-items:stretch}
      .title-gradient{font-size:20px}
    }

    input:focus,select:focus,textarea:focus,button:focus{outline:4px solid var(--focus);outline-offset:2px;border-radius:8px}
  </style>
</head>
<body data-theme="light">
  <!-- header with visible theme toggle -->
  <header class="sitehead" role="banner">
    <div class="sitehead-inner" aria-hidden="true">
      <!-- centered brand label area (keeps visual balance) -->
      <div style="text-align:center">
        <div style="font-weight:800;color:var(--muted)">SJ Consultation Team</div>
      </div>
    </div>

    <button id="themeToggle" class="theme-btn" aria-pressed="false" title="Toggle theme">
      <img id="themeIcon" src="https://i.imgur.com/xsbEuC5.png" alt="theme">
    </button>
  </header>

  <main class="page" role="main">
    <article class="card" aria-labelledby="formTitle">
      <!-- banner with your requested image (photo6) -->
      <div class="card-banner" role="img" aria-label="Consulting visual">
        <img src="https://i.imgur.com/t9Ojgbo.jpeg" alt="">
        <div class="banner-overlay">
          <div class="title-wrap">
            <h1 id="formTitle" class="title-gradient">Client Form</h1>
            <div class="subtitle">Secure application — email & cell verification (Canada only)</div>
          </div>
        </div>
      </div>

      <div class="card-body">
        <form id="clientForm" novalidate>
          <div class="grid">
            <div>
              <label for="fullName">Full name</label>
              <input id="fullName" name="fullName" type="text" required placeholder="Jane Doe">
            </div>

            <div>
              <label for="email">Email</label>
              <input id="email" name="email" type="email" required placeholder="name@domain.com">
            </div>

            <div>
              <label for="cell">Cell phone number</label>
              <input id="cell" name="cell" type="tel" required placeholder="+1 4165551234">
            </div>

            <div>
              <label for="province">Province / Territory</label>
              <select id="province" name="province" required>
                <option value="">Select</option>
                <option value="AB">Alberta</option>
                <option value="BC">British Columbia</option>
                <option value="MB">Manitoba</option>
                <option value="NB">New Brunswick</option>
                <option value="NL">Newfoundland and Labrador</option>
                <option value="NS">Nova Scotia</option>
                <option value="NT">Northwest Territories</option>
                <option value="NU">Nunavut</option>
                <option value="ON">Ontario</option>
                <option value="PE">Prince Edward Island</option>
                <option value="QC">Quebec</option>
                <option value="SK">Saskatchewan</option>
                <option value="YT">Yukon</option>
              </select>
            </div>

            <div class="full">
              <label for="city">City / Municipality</label>
              <input id="city" name="city" type="text" required placeholder="Toronto">
            </div>

            <div>
              <label for="postal">Postal code</label>
              <input id="postal" name="postal" type="text" required placeholder="A1A 1A1">
            </div>

            <div class="full">
              <label for="details">Project description</label>
              <textarea id="details" name="details" required minlength="13" maxlength="300" placeholder="Describe location, objectives, constraints (13–300 characters)"></textarea>
            </div>
          </div>

          <div id="formMessage" class="message" aria-live="polite"></div>

          <div class="actions">
            <button id="proceedBtn" class="btn btn-primary" type="button">Proceed & Verify</button>
            <button id="resetBtn" class="btn btn-ghost" type="button">Reset</button>
          </div>

          <!-- verification block (hidden until needed) -->
          <div id="verificationArea" class="verify-block" style="display:none" aria-hidden="true">
            <div style="font-weight:700;margin-bottom:6px">Verification</div>

            <div style="margin-bottom:10px">
              <div class="muted">Email:</div>
              <div id="v_email" style="font-weight:700">—</div>
              <div style="display:flex;gap:8px;margin-top:8px">
                <button id="checkEmailBtn" class="btn btn-primary" type="button">Check Email</button>
                <button id="resendEmailBtn" class="btn btn-ghost" type="button">Resend Email</button>
              </div>
              <div id="emailStatus" style="margin-top:8px"></div>
            </div>

            <div>
              <div class="muted">Cell:</div>
              <div id="v_cell" style="font-weight:700">—</div>
              <div id="recaptcha-container"></div>
              <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
                <input id="smsCode" placeholder="123456" style="flex:1;padding:10px;border-radius:8px;border:1px solid rgba(11,23,35,0.08)">
                <button id="confirmSmsBtn" class="btn btn-primary" type="button">Confirm SMS</button>
              </div>
              <div style="margin-top:8px">
                <button id="resendSmsBtn" class="btn btn-ghost" type="button">Resend SMS</button>
              </div>
              <div id="phoneStatus" style="margin-top:8px"></div>
            </div>

            <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:14px">
              <button id="finalizeBtn" class="btn btn-primary" type="button" disabled>Finalize Application</button>
              <button id="backBtn" class="btn btn-ghost" type="button">Back</button>
            </div>

            <div id="finalStatus" style="margin-top:12px"></div>
          </div>
        </form>
      </div>
    </article>
  </main>

  <script type="module">
  // ========== Firebase + logic (modular SDK v10) ==========
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import {
    getAuth,
    createUserWithEmailAndPassword,
    sendEmailVerification,
    RecaptchaVerifier,
    linkWithPhoneNumber,
    reload,
    signOut
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  // Firebase config (same as your project)
  const firebaseConfig = {
    apiKey: "AIzaSyCfa_A6jcAlL-ey8TPl21rvgcrRKulh3qo",
    authDomain: "sjdeveloper.firebaseapp.com",
    projectId: "sjdeveloper",
    storageBucket: "sjdeveloper.firebasestorage.app",
    messagingSenderId: "387394157316",
    appId: "1:387394157316:web:8f00fbec5dd8323655ae51",
    measurementId: "G-VJ3YT3LCGC"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  // attach for Recaptcha internal access safety
  window.auth = auth;
  const db = getFirestore(app);

  // UI refs
  const clientForm = document.getElementById('clientForm');
  const proceedBtn = document.getElementById('proceedBtn');
  const resetBtn = document.getElementById('resetBtn');
  const formMessage = document.getElementById('formMessage');
  const verificationArea = document.getElementById('verificationArea');
  const v_email = document.getElementById('v_email');
  const v_cell = document.getElementById('v_cell');
  const checkEmailBtn = document.getElementById('checkEmailBtn');
  const resendEmailBtn = document.getElementById('resendEmailBtn');
  const emailStatus = document.getElementById('emailStatus');
  const confirmSmsBtn = document.getElementById('confirmSmsBtn');
  const resendSmsBtn = document.getElementById('resendSmsBtn');
  const phoneStatus = document.getElementById('phoneStatus');
  const smsCodeInput = document.getElementById('smsCode');
  const finalizeBtn = document.getElementById('finalizeBtn');
  const backBtn = document.getElementById('backBtn');
  const finalStatus = document.getElementById('finalStatus');

  // form fields
  const fullNameEl = document.getElementById('fullName');
  const emailEl = document.getElementById('email');
  const cellEl = document.getElementById('cell');
  const provinceEl = document.getElementById('province');
  const cityEl = document.getElementById('city');
  const postalEl = document.getElementById('postal');
  const detailsEl = document.getElementById('details');

  // state
  let createdUser = null;
  let confirmationResult = null;
  let phoneLinked = false;
  let emailVerified = false;
  let recaptchaVerifier = null;

  // Canada area codes
  const CANADA_AREA_CODES = new Set([
    "204","236","249","250","289","306","343","365","403","416","418","431","437","438","450","506",
    "514","519","548","579","581","587","604","613","639","647","672","705","709","742","743","778",
    "780","782","807","819","825","867","873","902","905"
  ]);

  // helpers
  function escapeHtml(s=''){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  function showError(target, msg){ target.innerHTML = `<div class="error">${escapeHtml(msg)}</div>`; }
  function showSuccess(target, msg){ target.innerHTML = `<div class="success">${escapeHtml(msg)}</div>`; }
  function clearNode(target){ target.innerHTML = ''; }

  // validations
  function isValidCanadianPostal(pc){
    if(!pc) return false;
    return /^[A-Za-z]\d[A-Za-z][ ]?\d[A-Za-z]\d$/.test(pc.trim());
  }
  function isValidCanadianPhone(raw){
    if(!raw) return false;
    const s = raw.replace(/[^\d\+]/g,'');
    const normalized = s.startsWith('+') ? s : ('+' + s.replace(/^\+?/,''));
    if(!/^\+1\d{10}$/.test(normalized)) return false;
    const area = normalized.substr(2,3);
    return CANADA_AREA_CODES.has(area);
  }

  function validateForm(){
    clearNode(formMessage);
    if(!fullNameEl.value.trim()) { showError(formMessage,'Full name is required.'); return false; }
    const email = emailEl.value.trim();
    if(!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { showError(formMessage,'Valid email required.'); return false; }
    if(!isValidCanadianPhone(cellEl.value.trim())) { showError(formMessage,'Cell must be a valid Canadian number (include +1).'); return false; }
    if(!provinceEl.value) { showError(formMessage,'Select a province.'); return false; }
    if(!cityEl.value.trim()) { showError(formMessage,'City is required.'); return false; }
    if(!isValidCanadianPostal(postalEl.value.trim())) { showError(formMessage,'Valid Canadian postal code required (A1A 1A1).'); return false; }
    const d = detailsEl.value.trim();
    if(d.length < 13) { showError(formMessage,'Description must be at least 13 characters.'); return false; }
    if(d.length > 300) { showError(formMessage,'Description must be 300 characters or fewer.'); return false; }
    return true;
  }

  // Recaptcha prepare (stable)
  function prepareRecaptcha(){
    try{
      if(window.recaptchaVerifier){
        try{ window.recaptchaVerifier.clear(); } catch(e){}
        window.recaptchaVerifier = null;
      }
      document.getElementById('recaptcha-container').innerHTML = '';
    }catch(e){}
    window.recaptchaVerifier = new RecaptchaVerifier('recaptcha-container', { size: 'invisible' }, auth);
    recaptchaVerifier = window.recaptchaVerifier;
  }

  function generateTempPassword(len=14){
    const alpha = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*()-_=+';
    let out = '';
    if(window.crypto && crypto.getRandomValues){
      const arr = new Uint32Array(len); crypto.getRandomValues(arr);
      for(let i=0;i<len;i++) out += alpha[arr[i] % alpha.length];
    } else {
      for(let i=0;i<len;i++) out += alpha[Math.floor(Math.random()*alpha.length)];
    }
    return out;
  }

  // Start verification flow
  proceedBtn.addEventListener('click', async () => {
    clearNode(formMessage); clearNode(emailStatus); clearNode(phoneStatus); clearNode(finalStatus);
    if(!validateForm()) return;

    // show values in verification area
    v_email.textContent = emailEl.value.trim();
    v_cell.textContent = cellEl.value.trim();

    verificationArea.style.display = 'block';
    verificationArea.setAttribute('aria-hidden','false');

    proceedBtn.disabled = true;
    proceedBtn.textContent = 'Processing...';
    try{
      const tempPassword = generateTempPassword();
      const userCredential = await createUserWithEmailAndPassword(auth, emailEl.value.trim(), tempPassword);
      createdUser = userCredential.user;

      // send email verification
      await sendEmailVerification(createdUser);
      showSuccess(emailStatus, 'Verification email sent. Click the link then press Check Email.');

      // send SMS via linkWithPhoneNumber
      prepareRecaptcha();
      const normalizedCell = cellEl.value.trim().replace(/[^\d\+]/g,'');
      confirmationResult = await linkWithPhoneNumber(createdUser, normalizedCell, window.recaptchaVerifier);
      showSuccess(phoneStatus, 'SMS sent. Enter the code and confirm.');

      // initialize finalize state
      phoneLinked = false;
      emailVerified = false;
      finalizeBtn.disabled = true;
      finalStatus.innerHTML = '';
    } catch(err){
      console.error(err);
      if(err && err.code === 'auth/email-already-in-use'){
        showError(formMessage,'Email already registered. Check inbox for verification.');
      } else if(err && (err.code === 'auth/invalid-phone-number' || err.code === 'auth/missing-phone-number')){
        showError(formMessage,'Invalid phone number. Include +1 and a valid Canadian area code.');
      } else {
        showError(formMessage,'Failed to start verification: ' + (err.message || err.code || err));
      }
      // cleanup
      try{ await signOut(auth); }catch(e){}
      verificationArea.style.display = 'none';
      verificationArea.setAttribute('aria-hidden','true');
    } finally {
      proceedBtn.disabled = false;
      proceedBtn.textContent = 'Proceed & Verify';
    }
  });

  // Confirm SMS
  confirmSmsBtn.addEventListener('click', async () => {
    clearNode(phoneStatus);
    const code = smsCodeInput.value.trim();
    if(!code){ showError(phoneStatus,'Enter the 6-digit SMS code.'); return; }
    confirmSmsBtn.disabled = true; confirmSmsBtn.textContent = 'Confirming...';
    try{
      const res = await confirmationResult.confirm(code);
      phoneLinked = true;
      showSuccess(phoneStatus, 'Phone verified.');
      // reload user to check emailVerified
      await reload(auth.currentUser);
      emailVerified = !!auth.currentUser.emailVerified;
      if(emailVerified) showSuccess(emailStatus, 'Email verified.');
      updateFinalizeState();
    } catch(err){
      console.error(err);
      showError(phoneStatus,'SMS verification failed. Try resending.');
    } finally {
      confirmSmsBtn.disabled = false; confirmSmsBtn.textContent = 'Confirm SMS';
    }
  });

  // Resend SMS
  resendSmsBtn.addEventListener('click', async () => {
    clearNode(phoneStatus);
    try{
      prepareRecaptcha();
      const normalizedCell = cellEl.value.trim().replace(/[^\d\+]/g,'');
      confirmationResult = await linkWithPhoneNumber(createdUser, normalizedCell, window.recaptchaVerifier);
      showSuccess(phoneStatus,'SMS resent.');
    } catch(err){
      console.error(err);
      showError(phoneStatus,'Failed to resend SMS: ' + (err.message || err.code || err));
    }
  });

  // Resend email
  resendEmailBtn.addEventListener('click', async () => {
    clearNode(emailStatus);
    try{
      if(!createdUser){ showError(emailStatus,'Start verification first.'); return; }
      await sendEmailVerification(createdUser);
      showSuccess(emailStatus,'Verification email resent.');
    } catch(err){
      console.error(err);
      showError(emailStatus,'Failed to resend email.');
    }
  });

  // Check email verification
  checkEmailBtn.addEventListener('click', async () => {
    clearNode(emailStatus);
    try{
      await reload(auth.currentUser);
      emailVerified = !!auth.currentUser.emailVerified;
      if(emailVerified) showSuccess(emailStatus,'Email verified.');
      else showError(emailStatus,'Email not verified yet. Click the link in the email.');
      updateFinalizeState();
    } catch(err){
      console.error(err);
      showError(emailStatus,'Failed to check verification.');
    }
  });

  function updateFinalizeState(){
    if(phoneLinked && emailVerified){
      finalizeBtn.disabled = false;
      finalStatus.innerHTML = '';
    } else {
      finalizeBtn.disabled = true;
      let missing = [];
      if(!phoneLinked) missing.push('phone');
      if(!emailVerified) missing.push('email');
      finalStatus.innerHTML = `<div class="muted small">Waiting for: ${missing.join(' & ')}</div>`;
    }
  }

  // Finalize: validate again & save to Firestore
  finalizeBtn.addEventListener('click', async () => {
    clearNode(finalStatus);
    if(!validateForm()){ showError(finalStatus,'Validation failed — correct fields and try again.'); return; }
    finalizeBtn.disabled = true; finalizeBtn.textContent = 'Submitting...';
    try{
      const doc = {
        name: fullNameEl.value.trim(),
        email: emailEl.value.trim(),
        cell: cellEl.value.trim().replace(/[^\d\+]/g,''),
        province: provinceEl.value,
        city: cityEl.value.trim(),
        postal: postalEl.value.trim().toUpperCase(),
        details: detailsEl.value.trim(),
        emailVerified: !!auth.currentUser.emailVerified,
        phoneLinked: !!phoneLinked,
        createdAt: serverTimestamp()
      };
      await addDoc(collection(db, 'applications'), doc);
      showSuccess(finalStatus, 'Application submitted. SJ Consultation Team will review and contact you.');
      // sign out and lock fields for security
      try{ await signOut(auth); }catch(e){}
      clientForm.querySelectorAll('input,textarea,select,button').forEach(el=>el.disabled = true);
    } catch(err){
      console.error(err);
      showError(finalStatus,'Failed to submit: ' + (err.message || err.code || err));
      finalizeBtn.disabled = false; finalizeBtn.textContent = 'Finalize Application';
    }
  });

  // Back button hides verification block
  backBtn.addEventListener('click', ()=> {
    verificationArea.style.display = 'none';
    verificationArea.setAttribute('aria-hidden','true');
    clearNode(emailStatus); clearNode(phoneStatus); clearNode(finalStatus);
    try{ smsCodeInput.value = ''; }catch(e){}
  });

  // Reset clears form and signs out
  resetBtn.addEventListener('click', async () => {
    clientForm.reset();
    clearNode(formMessage); clearNode(emailStatus); clearNode(phoneStatus); clearNode(finalStatus);
    verificationArea.style.display = 'none';
    verificationArea.setAttribute('aria-hidden','true');
    try{ await signOut(auth); }catch(e){}
  });

  // live update of verification displays
  [emailEl,cellEl].forEach(el => el && el.addEventListener('input', ()=>{
    v_email.textContent = emailEl.value.trim() || '—';
    v_cell.textContent = cellEl.value.trim() || '—';
  }));

  // Clean up auth on unload
  window.addEventListener('beforeunload', async () => {
    try{ await signOut(auth); }catch(e){}
  });

  // ========== Theme toggle (clear visible icon) ==========
  (function(){
    const key = 'sj_theme';
    const themeToggle = document.getElementById('themeToggle');
    const themeIcon = document.getElementById('themeIcon');
    const ICON_LIGHT = 'https://i.imgur.com/xsbEuC5.png';
    const ICON_DARK  = 'https://i.imgur.com/vrfrd6g.png';
    const root = document.documentElement;
    const saved = localStorage.getItem(key) || 'light';
    root.setAttribute('data-theme', saved);
    themeIcon.src = (saved === 'dark') ? ICON_DARK : ICON_LIGHT;
    themeToggle.setAttribute('aria-pressed', saved === 'dark' ? 'true' : 'false');
    themeToggle.addEventListener('click', ()=>{
      const cur = root.getAttribute('data-theme') === 'dark' ? 'dark' : 'light';
      const next = cur === 'dark' ? 'light' : 'dark';
      root.setAttribute('data-theme', next);
      localStorage.setItem(key, next);
      themeIcon.src = (next === 'dark') ? ICON_DARK : ICON_LIGHT;
      themeToggle.setAttribute('aria-pressed', next === 'dark' ? 'true' : 'false');
    });
  })();

  </script>
</body>
</html>
